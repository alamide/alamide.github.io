---
layout: post
title:  "LeetCode1795"
date:   2023-02-16
categories: LeetCode SQL
tags: LeetCode SQL 
sql_table: sql-leetcode-1795.html
---
### 行转列

* 重构 t_products 表，查询每个产品在不同商店的价格，使得输出的格式变为(product_id, store, price) 即t_trans_products。如果这一产品在商店里没有出售，则不输出这一行。

```sql
select product_id, 'store1' as store, store1 as price from t_products where store1 is not null
union all
select product_id, 'store2' as store, store2 as price from t_products where store2 is not null
union all
select product_id, 'store3' as store, store3 as price from t_products where store3 is not null;
```
<table border="1" style="border-collapse:collapse">
  <tr><th>product_id</th><th>store</th><th>price</th></tr>
  <tr><td>0</td><td>store1</td><td>95</td></tr>
  <tr><td>0</td><td>store2</td><td>100</td></tr>
  <tr><td>0</td><td>store3</td><td>105</td></tr>
  <tr><td>1</td><td>store1</td><td>70</td></tr>
  <tr><td>1</td><td>store3</td><td>80</td></tr>
</table>

将输出的结果插入 t_trans_products
```sql
insert into t_trans_products(product_id, store, price)
    select * from (
        select product_id, 'store1' as store, store1 as price from t_products where store1 is not null
        union all
        select product_id, 'store2' as store, store2 as price from t_products where store2 is not null
        union all
        select product_id, 'store3' as store, store3 as price from t_products where store3 is not null
        order by product_id, store
    ) as t_temp;
```

* 重构 t_trans_products 表，输出的格式变为(product_id, store1, store2, store3) 即t_products。如果这一产品在商店里没有出售，则该列为NULL。
  
```sql
select
    product_id,
    sum(if(store='store1', price, null)) store1,
    sum(if(store='store2', price, null)) store2,
    sum(if(store='store3', price, null)) store3
from t_trans_products
group by product_id;
```
<table border="1" style="border-collapse:collapse">
  <tr><th>product_id</th><th>store1</th><th>store2</th><th>store3</th></tr>
  <tr><td>0</td><td>95</td><td>100</td><td>105</td></tr>
  <tr><td>1</td><td>70</td><td>NULL</td><td>80</td></tr>
</table>

sum 是聚合函数，将分组中的对应列数值相加。`可以理解为遍历结果集，将对应列相加`。

其它的聚合函数也可以如 `max(if(store='store1', price, null))`

对于分组 product_id=0 `sum(if(store='store1', price, null))` 即表示 price + null + null。price 为 95

对于分组 product_id=1 `sum(if(store='store2', price, null))` 即表示 null + null + null。





